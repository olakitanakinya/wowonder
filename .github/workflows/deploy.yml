name: Deploy Wowonder
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup k8s
      uses: azure/setup-kubectl@v3
      
    - name: Configure kubeconfig
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
        kubectl get nodes

    - name: Create namespace
      run: kubectl apply -f k8s/namespace.yaml

    - name: Deploy storage
      run: kubectl apply -f k8s/storage.yaml

    - name: Deploy MySQL
      run: |
        kubectl apply -f k8s/mysql.yaml
        kubectl wait --for=condition=ready pod -l app=mysql -n wowonder --timeout=300s

    - name: Initialize database
      run: |
        POD=$(kubectl get pods -l app=mysql -n wowonder -o name)
        kubectl exec -n wowonder $POD -- mysql -uroot -prootpassword -e "
          CREATE DATABASE IF NOT EXISTS wowonderdb;
          CREATE USER IF NOT EXISTS 'wowonderuser'@'%' IDENTIFIED BY 'Password123@24';
          GRANT ALL PRIVILEGES ON wowonderdb.* TO 'wowonderuser'@'%';
          FLUSH PRIVILEGES;
        "
        if [ -f "wowonderdb.sql" ]; then
          kubectl cp wowonderdb.sql wowonder/$POD:/tmp/db.sql
          kubectl exec -n wowonder $POD -- mysql -uroot -prootpassword wowonderdb < /tmp/db.sql
        fi

    - name: Deploy application
      run: |
        sed "s|\$DOCKERHUB_USERNAME|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/laravel.yaml | kubectl apply -f -
        kubectl wait --for=condition=ready pod -l app=wowonder-app -n wowonder --timeout=300s

    - name: Verify
      run: |
        kubectl get all,pv,pvc -n wowonder
        echo "App URL: http://44.220.139.238:30080"
