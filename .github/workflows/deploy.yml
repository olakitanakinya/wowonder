name: Deploy Wowonder
on:
  push:
    branches: [main]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/wowonder-laravel
  NAMESPACE: wowonder
  K8S_WORKER_IP: 44.220.139.238

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Fix config.php port
      run: |
        echo "=== Fixing config.php port ==="
        if [ -f "config.php" ]; then
          sed -i 's/:3008/:30080/g' config.php
          echo "Updated port from 3008 to 30080 in config.php"
        else
          echo "Creating config.php with correct port..."
          echo '<?php' > config.php
          echo '$sql_db_host = "mysql-service";' >> config.php
          echo '$sql_db_user = "wowonderuser";' >> config.php
          echo '$sql_db_pass = "Password123@24";' >> config.php
          echo '$sql_db_name = "wowonderdb";' >> config.php
          echo '$site_url = "http://44.220.139.238:30080";' >> config.php
          echo '$auto_redirect = true;' >> config.php
          echo '$purchase_code = "000000";' >> config.php
          echo '$siteEncryptKey = "eb733cdb4d769426e460bad9df6b824eee3416d7";' >> config.php
          echo '?>' >> config.php
        fi

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.DOCKER_IMAGE }}:latest
          ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Kubernetes
      uses: azure/setup-kubectl@v3
      
    - name: Configure kubeconfig
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
        kubectl config set-cluster kubernetes --server=https://54.159.42.214:6443 --insecure-skip-tls-verify=true
        kubectl get nodes

    - name: Cleanup previous deployment
      run: |
        echo "=== Cleaning previous deployment ==="
        kubectl delete all --all -n ${{ env.NAMESPACE }} --ignore-not-found=true
        kubectl delete pvc -n ${{ env.NAMESPACE }} --all --ignore-not-found=true
        kubectl delete pv --all --ignore-not-found=true
        kubectl delete namespace ${{ env.NAMESPACE }} --ignore-not-found=true
        sleep 10

    - name: Create namespace
      run: |
        kubectl create namespace ${{ env.NAMESPACE }}
        echo "Namespace ${{ env.NAMESPACE }} created"

    - name: Setup storage directories on worker node
      run: |
        echo "=== Setting up storage directories on worker node ==="
        # Create storage directories on worker node using a Kubernetes job
        cat <<EOF | kubectl apply -f -
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: storage-setup
          namespace: ${{ env.NAMESPACE }}
        spec:
          template:
            spec:
              nodeSelector:
                kubernetes.io/hostname: worker
              containers:
              - name: storage-setup
                image: busybox:1.35
                command:
                - /bin/sh
                - -c
                - |
                  echo "Creating storage directories on worker node..."
                  mkdir -p /mnt/data/wowonder /mnt/data/mysql
                  chmod -R 777 /mnt/data
                  echo "Storage directories created successfully"
                  ls -la /mnt/data/
                volumeMounts:
                - name: host-root
                  mountPath: /mnt
              restartPolicy: OnFailure
              volumes:
              - name: host-root
                hostPath:
                  path: /
                  type: Directory
        EOF
        
        # Wait for job completion
        echo "Waiting for storage setup job to complete..."
        kubectl wait --for=condition=complete job/storage-setup -n ${{ env.NAMESPACE }} --timeout=60s
        
        # Check job logs
        kubectl logs job/storage-setup -n ${{ env.NAMESPACE }}
        
        # Cleanup job
        kubectl delete job/storage-setup -n ${{ env.NAMESPACE }} --ignore-not-found=true

    - name: Deploy storage
      run: |
        echo "=== Deploying Storage ==="
        kubectl apply -f k8s/storage.yaml
        sleep 15
        
        echo "=== Storage Status ==="
        kubectl get pv,pvc -n ${{ env.NAMESPACE }} -o wide
        
        echo "=== PVC Details ==="
        kubectl describe pvc -n ${{ env.NAMESPACE }}

    - name: Deploy MySQL
      run: |
        echo "=== Deploying MySQL ==="
        kubectl apply -f k8s/mysql.yaml
        
        echo "=== Checking MySQL Pod Status ==="
        timeout 300s bash -c '
          while true; do
            POD_STATUS=$(kubectl get pods -l app=mysql -n ${{ env.NAMESPACE }} -o jsonpath="{.items[0].status.phase}" 2>/dev/null || echo "NotFound")
            POD_NODE=$(kubectl get pods -l app=mysql -n ${{ env.NAMESPACE }} -o jsonpath="{.items[0].spec.nodeName}" 2>/dev/null || echo "NoNode")
            
            echo "Pod Status: $POD_STATUS, Node: $POD_NODE"
            
            if [ "$POD_STATUS" = "Running" ]; then
              echo "✓ MySQL pod is running"
              break
            elif [ "$POD_STATUS" = "Pending" ]; then
              echo "⏳ MySQL pod is pending..."
              # Get detailed pod info
              MYSQL_POD=$(kubectl get pods -l app=mysql -n ${{ env.NAMESPACE }} -o jsonpath="{.items[0].metadata.name}" 2>/dev/null || echo "not-found")
              if [ "$MYSQL_POD" != "not-found" ]; then
                kubectl describe pod $MYSQL_POD -n ${{ env.NAMESPACE }}
                
                # Check events
                echo "=== Recent Events ==="
                kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -10
              fi
              sleep 20
            elif [ "$POD_STATUS" = "NotFound" ]; then
              echo "⏳ MySQL pod not created yet..."
              sleep 10
            else
              echo "⏳ MySQL pod status: $POD_STATUS"
              sleep 10
            fi
          done
        '
        
        # Wait for pod to be ready
        echo "Waiting for MySQL to be ready..."
        kubectl wait --for=condition=ready pod -l app=mysql -n ${{ env.NAMESPACE }} --timeout=600s

    - name: Check MySQL pod status
      run: |
        echo "=== MySQL Pod Status ==="
        kubectl get pods -l app=mysql -n ${{ env.NAMESPACE }} -o wide
        echo ""
        echo "=== MySQL Pod Logs ==="
        MYSQL_POD=$(kubectl get pods -l app=mysql -n ${{ env.NAMESPACE }} -o jsonpath='{.items[0].metadata.name}')
        kubectl logs $MYSQL_POD -n ${{ env.NAMESPACE }} --tail=20


        - name: Initialize database
      run: |
        echo "=== Initializing Database ==="
        MYSQL_POD=$(kubectl get pods -l app=mysql -n ${{ env.NAMESPACE }} -o jsonpath='{.items[0].metadata.name}')
        echo "MySQL pod: $MYSQL_POD"
        
        # Wait for MySQL to be ready to accept connections
        echo "Waiting for MySQL to accept connections..."
        timeout 180s bash -c "
          while ! kubectl exec -n ${{ env.NAMESPACE }} $MYSQL_POD -- mysqladmin ping -uroot -prootpassword --silent; do
            echo '⏳ MySQL not ready yet...'
            sleep 10
          done
          echo '✓ MySQL is ready and accepting connections'
        "
        
        # Create database and user
        echo "Creating database and user..."
        kubectl

    - name: Deploy application
      run: |
        echo "=== Deploying Application ==="
        # Create a temporary file with the image replaced
        cat k8s/laravel.yaml | sed "s|\$DOCKER_IMAGE|${{ env.DOCKER_IMAGE }}|g" > k8s/laravel-deploy.yaml
        kubectl apply -f k8s/laravel-deploy.yaml
        
        echo "Waiting for application pod..."
        timeout 180s bash -c '
          while true; do
            POD_STATUS=$(kubectl get pods -l app=wowonder-app -n ${{ env.NAMESPACE }} -o jsonpath="{.items[0].status.phase}" 2>/dev/null || echo "NotFound")
            if [ "$POD_STATUS" = "Running" ]; then
              echo "✓ Application pod is running"
              break
            elif [ "$POD_STATUS" = "NotFound" ]; then
              echo "⏳ Application pod not found yet..."
            else
              echo "⏳ Application pod status: $POD_STATUS"
            fi
            sleep 10
          done
        '

    - name: Create config in pod
      run: |
        echo "=== Creating Config in Pod ==="
        APP_POD=$(kubectl get pods -l app=wowonder-app -n ${{ env.NAMESPACE }} -o name 2>/dev/null || echo "NOT_FOUND")
        
        if [ "$APP_POD" != "NOT_FOUND" ]; then
          # Create config.php using multiple commands to avoid heredoc issues
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '<?php' > /var/www/html/config.php"
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '\$sql_db_host = \"mysql-service\";' >> /var/www/html/config.php"
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '\$sql_db_user = \"wowonderuser\";' >> /var/www/html/config.php"
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '\$sql_db_pass = \"Password123@24\";' >> /var/www/html/config.php"
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '\$sql_db_name = \"wowonderdb\";' >> /var/www/html/config.php"
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '\$site_url = \"http://44.220.139.238:30080\";' >> /var/www/html/config.php"
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '\$auto_redirect = true;' >> /var/www/html/config.php"
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '\$purchase_code = \"000000\";' >> /var/www/html/config.php"
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '\$siteEncryptKey = \"eb733cdb4d769426e460bad9df6b824eee3416d7\";' >> /var/www/html/config.php"
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- sh -c "echo '?>' >> /var/www/html/config.php"
          
          # Set permissions
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- chown www-data:www-data /var/www/html/config.php
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- chmod 644 /var/www/html/config.php
          
          echo "✓ Configuration files updated"
        else
          echo "❌ Cannot create config - application pod not found"
        fi

    - name: Test database connection from app
      run: |
        echo "=== Testing Database Connection from Application ==="
        APP_POD=$(kubectl get pods -l app=wowonder-app -n ${{ env.NAMESPACE }} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "NOT_FOUND")
        
        if [ "$APP_POD" != "NOT_FOUND" ]; then
          kubectl exec -n ${{ env.NAMESPACE }} $APP_POD -- php -r "\
          \$conn = new mysqli('mysql-service', 'wowonderuser', 'Password123@24', 'wowonderdb', 3306);\
          if (\$conn->connect_error) {\
              echo '❌ DATABASE ERROR: ' . \$conn->connect_error;\
              exit(1);\
          } else {\
              echo '✓ DATABASE SUCCESS: Connected to MySQL';\
              \$result = \$conn->query('SHOW TABLES');\
              if (\$result && \$result->num_rows > 0) {\
                  echo '✓ Database has tables: ' . \$result->num_rows;\
              } else {\
                  echo '⚠ Database is empty or tables query failed';\
              }\
              \$conn->close();\
          }\
          " || echo "Database test completed"
        else
          echo "❌ Cannot test database - application pod not found"
        fi

    - name: Test application
      run: |
        echo "=== Testing Application ==="
        echo "Waiting for application to be fully ready..."
        sleep 30
        
        echo "--- Testing Basic Connectivity ---"
        curl -s -o /dev/null -w "Root Endpoint: %{http_code}\n" http://${{ env.K8S_WORKER_IP }}:30080/ || echo "❌ Root endpoint failed"
        
        echo "--- Testing Welcome Page ---"
        curl -s -o /dev/null -w "Welcome Page: %{http_code}\n" http://${{ env.K8S_WORKER_IP }}:30080/welcome || echo "❌ Welcome page failed"
        
        echo "--- Testing Static Files ---"
        curl -s -o /dev/null -w "CSS File: %{http_code}\n" http://$${{ env.K8S_WORKER_IP }}:30080/themes/wowonder/css/style.css || echo "❌ CSS file failed"
        
        echo "--- Testing PHP ---"
        curl -s -o /dev/null -w "PHP Index: %{http_code}\n" http://${{ env.K8S_WORKER_IP }}:30080/index.php || echo "❌ PHP failed"

    - name: Show status
      run: |
        echo "=== 🎉 FINAL DEPLOYMENT STATUS ==="
        echo ""
        echo "📊 CLUSTER STATUS:"
        kubectl get all -n ${{ env.NAMESPACE }}
        
        echo ""
        echo "💾 STORAGE STATUS:"
        kubectl get pv,pvc -n ${{ env.NAMESPACE }}
        
        echo ""
        echo "🌐 APPLICATION URLS:"
        echo "   Main Site:      http://${{ env.K8S_WORKER_IP }}:30080/"
        echo "   Welcome Page:   http://${{ env.K8S_WORKER_IP }}:30080/welcome"
        echo "   Registration:   http://${{ env.K8S_WORKER_IP }}:30080/register"
        echo "   Login:          http://${{ env.K8S_WORKER_IP }}:30080/login"
        
        echo ""
        echo "✅ DEPLOYMENT COMPLETE"
